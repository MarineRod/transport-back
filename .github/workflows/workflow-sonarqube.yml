name: CI/CD Back - transport-back
# Execut√© seulement lors des merge sur main, permet d'obtenir un rapport SonarCube
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test unitaires (JaCoco)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du code              # R√©cup√©ration du code sur la VM
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configuration de JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Cache des d√©pendances Maven   # Mise en cache des d√©pendances Maven pour ne pas avoir √† les t√©l√©charger √† chaque fois
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Execution Tests               # Ex√©cution des tests unitaires
        run: mvn clean test jacoco:report

      - name: Archivage du rapport JaCoCo   # On sauvegarde le rapport jaCoco
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco/

  sonarqube:
    name: Analyse SonarCloud
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Installer jq                  # Package permettant de manipuler du JSON en shell
        run: sudo apt-get install jq

      - name: Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configuration de JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar


      - name: Execution Tests et JaCoCo
        run: mvn clean test jacoco:report

      - name: Analyse SonarCloud                # Analyse SonarQube via SonarCloud
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }} # Correspond √† un secret d√©fini dans le repository Github
        run: mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.projectKey=MarineRod_transport-back

#      - name: V√©rification du Quality Gate      # On v√©rifie que le rapport SonarQube g√©n√©r√© ne contient pas d'erreurs, si oui, le job est mis en erreur.
#        env:
#          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#        run: |
#          PROJECT_KEY="MarineRod_transport-back"
#
#          echo "üîç V√©rification du Quality Gate pour le projet: $PROJECT_KEY"
#
#          # Attendre que l'analyse soit trait√©e
#          echo "‚è≥ Attente de 30 secondes pour le traitement de l'analyse..."
#          sleep 30
#
#          # Nouvelle approche : utiliser l'API qualitygates/project_status directement
#          echo "üîç R√©cup√©ration du statut du Quality Gate..."
#
#          response=$(curl -s -u $SONAR_TOKEN: \
#            "https://sonarcloud.io/api/qualitygates/project_status?projectKey=$PROJECT_KEY")
#
#          echo "üìä R√©ponse de l'API SonarCloud:"
#          echo "$response" | jq '.'
#
#          # Extraire le statut
#          status=$(echo "$response" | jq -r '.projectStatus.status')
#
#          echo "üìà Statut du Quality Gate: $status"
#
#          # V√©rifier si le statut est valide
#          if [ "$status" = "null" ] || [ -z "$status" ]; then
#            echo "‚ùå Impossible de r√©cup√©rer le statut du Quality Gate"
#            echo "üîç Tentative avec une approche alternative..."
#
#            # Approche alternative : v√©rifier les m√©triques directement
#            metrics_response=$(curl -s -u $SONAR_TOKEN: \
#              "https://sonarcloud.io/api/measures/component?component=$PROJECT_KEY&metricKeys=alert_status")
#
#            echo "üìä R√©ponse des m√©triques:"
#            echo "$metrics_response" | jq '.'
#
#            alert_status=$(echo "$metrics_response" | jq -r '.component.measures[0].value')
#
#            if [ "$alert_status" = "OK" ]; then
#              echo "‚úÖ Quality Gate: OK (via m√©triques)"
#              exit 0
#            elif [ "$alert_status" = "ERROR" ]; then
#              echo "‚ùå Quality Gate: FAILED (via m√©triques)"
#              exit 1
#            else
#              echo "‚ö†Ô∏è  Statut du Quality Gate non d√©termin√©, mais poursuite du pipeline"
#              exit 0
#            fi
#          fi
#
#          # V√©rifier le statut principal
#          if [ "$status" = "OK" ]; then
#            echo "‚úÖ Quality Gate: OK"
#            exit 0
#          elif [ "$status" = "ERROR" ]; then
#            echo "‚ùå Quality Gate: FAILED"
#            # Afficher les d√©tails des conditions qui ont √©chou√©
#            echo "üìã D√©tails des conditions:"
#            echo "$response" | jq '.projectStatus.conditions[] | select(.status == "ERROR")'
#            exit 1
#          else
#            echo "‚ö†Ô∏è  Statut du Quality Gate: $status (non critique)"
#            exit 0
#          fi

  build:                                        # Build pour un possible deploy apr√®s
    name: Build du projet
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Construction du projet
        run: mvn -B package --file pom.xml -DskipTests

      - name: Archivage des artefacts
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: target/*.jar




